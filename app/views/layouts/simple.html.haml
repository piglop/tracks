!!!
%html{ :xmlns => "http://www.w3.org/1999/xhtml" }
  %head
    %meta{ :content => "text/html; charset=UTF-8", "http-equiv" => "Content-Type" }
    - if @prefs.refresh != 0
      %meta{ :content => "#{@prefs['refresh'].to_i*60};url=#{request.request_uri}", "http-equiv" => "Refresh" }
    = javascript_include_tag "jquery-1.2.6.min"
    - bundle do
      = javascript_include_tag *%w[ hoverIntent superfish prototype effects dragdrop controls application calendar calendar-en calendar-setup accesskey-hints todo-items niftycube protoload flashobject lowpro ]
      = stylesheet_link_tag *%w[ standard superfish calendar-system niftyCorners]
    = javascript_include_tag :unobtrusive
    = stylesheet_link_tag "print", :media => "print"
    %link{ :href => url_for(:controller => 'favicon.ico'), :rel => "shortcut icon" }
    = auto_discovery_link_tag(:rss, {:controller => "todos", :action => "index", :format => 'rss', :token => "#{current_user.token}"}, {:title => "RSS feed of next actions"})
    %link{ :href => search_plugin_path, :title => "Tracks", :rel => "search", :type => "application/opensearchdescription+xml" }
    %title
      = @page_title
  %body{ :class => @controller.controller_name }
    #topbar
      #date
        %h1
          - if @count
            %span#badge_count.badge
            = @count
          = current_user.time.strftime(@prefs.title_date_format)
      #minilinks
        = link_to("Toggle notes", "#", {:accesskey => "S", :title => "Toggle all notes", :id => "toggle-notes-nav"})
        \&nbsp;|&nbsp;
        = link_to "Logout (#{current_user.display_name}) Â»", logout_path
      #navcontainer
        %ul.sf-menu
          %li
            = navigation_link("Home", home_path, {:accesskey => "t", :title => "Home"} )
          %li
            = navigation_link("Starred", tag_path("starred"), :title => "See your starred actions" )
          %li
            = navigation_link("Projects", projects_path, {:accesskey=>"p", :title=>"Projects"} )
          %li
            = navigation_link("Tickler", tickler_path, {:accesskey =>"k", :title => "Tickler"} )
          %li
            %a{ :href => "#" }
              Organize
            %ul
              %li
                = navigation_link( "Contexts", contexts_path, {:accesskey=>"c", :title=>"Contexts"} )
              %li
                = navigation_link( "Notes", notes_path, {:accesskey => "o", :title => "Show all notes"} )
              %li
                = navigation_link( "Repeating todos", {:controller => "recurring_todos", :action => "index"}, :title => "Manage recurring actions" )
          %li
            %a{ :href => "#" }
              View
            %ul
              %li
                = navigation_link( "Calendar", calendar_path, :title => "Calendar of due actions" )
              %li
                = navigation_link( "Done", done_path, {:accesskey=>"d", :title=>"Completed"} )
              %li
                = navigation_link( "Feeds", {:controller => "feedlist", :action => "index"}, :title => "See a list of available feeds" )
              %li
                = navigation_link( "Statistics", {:controller => "stats", :action => "index"}, :title => "See your statistics" )
            %li
              %a{ :href => "#" }
                Admin
              %ul
                %li
                  = navigation_link( "Preferences", preferences_path, {:accesskey => "u", :title => "Show my preferences"} )
                %li
                  = navigation_link( "Export", {:controller => "data", :action => "index"}, {:accesskey => "i", :title => "Import and export data"} )
                - if current_user.is_admin?
                  %li
                  = navigation_link("Manage users", users_path, {:accesskey => "a", :title => "Add or delete users"} )
            %li
              %a{ :href => "#" }
                ?
              %ul
                %li
                  = link_to 'Integrate Tracks', integrations_path
                %li
                  = link_to 'REST API Docs', url_for(:controller => 'integrations', :action => 'rest_api')
            %li
              = navigation_link(image_tag("system-search.png", :size => "16X16", :border => 0), {:controller => "search", :action => "index"}, :title => "Search All Items" )
      = render_flash
    #content
      - unless @controller_name == 'feed' or session['noexpiry'] == "on"
        = periodically_call_remote( :url => {:controller => "login", :action => "check_expiry"}, :frequency => (5*60))
      = periodically_call_remote( :url => formatted_check_deferred_todos_path(:js), :method => :post, :frequency => (10*60))
      = yield
    = render :partial => "shared/footer"
    %script{ :type => "text/javascript" }
      jQuery(document).ready(function() { /* main menu */
      jQuery('ul.sf-menu').superfish({
      delay: 250,
      animation:   {opacity:'show',height:'show'},
      autoArrows: false,
      dropShadows: false,
      speed: 'fast'
      });
      jQuery('ul.sf-item-menu').superfish({ /* context menu */
      delay: 100,
      animation:   {opacity:'show',height:'show'},
      autoArrows: false,
      dropShadows: false,
      speed: 'fast',
      onBeforeShow: function() { /* highlight todo */
      $(this.parent().parent().parent()).addClass("sf-item-selected");
      },
      onHide: function() { /* remove hightlight from todo */
      $(this.parent().parent().parent()).removeClass("sf-item-selected");
      }
      });
      \/* for toggle notes link in mininav */
      jQuery("#toggle-notes-nav").click(function () { jQuery(".todo_notes").toggle(); });
      \/* show the notes of a todo */
      TodoBehavior.enableToggleNotes();
      Nifty("div#todo_new_action_container","normal");
      if ($('flash').visible()) { new Effect.Fade("flash",{duration:5.0}); }
      });
